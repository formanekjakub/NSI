{% extends 'layout.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
  .center-content {
    display: flex;
    flex-direction: column;
    justify-content: center;  /* vertical centering */
    align-items: center;      /* horizontal centering */
    height: 20vh;            /* full viewport height */
    text-align: center;
  }
</style>

<div class="center-content">
  <h1>Chytrý květináče</h1>
  <h4>šťastná záhrádka</h4>
</div>


<form method="get" action="{{ url_for('dashboard') }}" class="mb-3 d-flex align-items-center" style="max-width: 400px;">
  <label for="n" class="form-label mb-0 me-2">Počet záznamů:</label>
  <div class="input-group">
    <input type="number" name="n" value="{{ n }}" min="1" max="100" class="form-control">
    <button type="submit" class="btn btn-secondary">Zobrazit</button>
  </div>
</form>


<br>
<button class="btn btn-outline-danger btn-sm" onclick="deleteAllData();">Smazat všechny záznamy</button>
<br>

{% for label, key in chart_info %}
<div class="row mt-5">
  <!-- Table -->
  <div class="col-md-7">
    <h5>{{ label }}</h5>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>{{ label }}</th>
                <th>Čas odeslání</th>
                <th>Čas přijetí</th>
                <th>Smazat</th>
            </tr>
        </thead>
        <tbody>
            {% for row in measurements %}
              <tr id="row-{{ row['id'] }}">
                  <td>{{ row['id'] }}</td>
                  <td>{{ row[key] }}</td>
                  <td>{{ row['timestamp_sent'] }}</td>
                  <td>{{ row['timestamp_received'] }}</td>
                  <td>
                      <button
                        class="btn btn-outline-danger btn-sm"
                        onclick="deleteData({{ row['id'] }});"
                      >Smazat</button>
                    </td>
              </tr>
            {% endfor %}
        </tbody>
    </table>
  </div>

  <!-- Chart -->
  <div class="col-md-5">
    <canvas id="{{ key }}Chart" width="400" height="200"></canvas>
  </div>
</div>
{% endfor %}



<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const timeLabels = {{ labels | tojson }};

  const datasets = {
    temperature: {
      label: "Teplota (°C)",
      data: {{ temps | tojson }},
    },
    humidity: {
      label: "Vlhkost (%)",
      data: {{ humidities | tojson }},
    },
    soil_moisture: {
      label: "Půdní vlhkost",
      data: {{ moistures | tojson }},
    },
    light: {
      label: "Světlo",
      data: {{ lights | tojson }},
    }
  };


  Object.entries(datasets).forEach(([key, config]) => {
    const ctx = document.getElementById(`${key}Chart`).getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: [{
          label: config.label,
          data: config.data,
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 2,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Čas přijetí' } },
          y: {
            title: { display: true, text: config.label },
            beginAtZero: true
          }
        }
      }
    });
  });
});
</script>

{% endblock %}
